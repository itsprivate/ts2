import { sprintf } from "../../fmt/printf.ts";
import { inspect } from "../util.ts";
let debugImpls;
let testEnabled;
function initializeDebugEnv(debugEnv) {
    debugImpls = Object.create(null);
    if (debugEnv) {
        debugEnv = debugEnv.replace(/[|\\{}()[\]^$+?.]/g, "\\$&")
            .replaceAll("*", ".*")
            .replaceAll(",", "$|^");
        const debugEnvRegex = new RegExp(`^${debugEnv}$`, "i");
        testEnabled = (str) => debugEnvRegex.exec(str) !== null;
    }
    else {
        testEnabled = () => false;
    }
}
function emitWarningIfNeeded(set) {
    if ("HTTP" === set || "HTTP2" === set) {
        console.warn("Setting the NODE_DEBUG environment variable " +
            "to '" + set.toLowerCase() + "' can expose sensitive " +
            "data (such as passwords, tokens and authentication headers) " +
            "in the resulting log.");
    }
}
const noop = () => { };
function debuglogImpl(enabled, set) {
    if (debugImpls[set] === undefined) {
        if (enabled) {
            emitWarningIfNeeded(set);
            debugImpls[set] = function debug(...args) {
                const msg = args.map((arg) => inspect(arg)).join(" ");
                console.error(sprintf("%s %s: %s\n", set, String(Deno.pid), msg));
            };
        }
        else {
            debugImpls[set] = noop;
        }
    }
    return debugImpls[set];
}
function debuglog(set, cb) {
    function init() {
        set = set.toUpperCase();
        enabled = testEnabled(set);
    }
    let debug = (...args) => {
        init();
        debug = debuglogImpl(enabled, set);
        if (typeof cb === "function") {
            cb(debug);
        }
        return debug(...args);
    };
    let enabled;
    let test = () => {
        init();
        test = () => enabled;
        return enabled;
    };
    const logger = (...args) => debug(...args);
    Object.defineProperty(logger, "enabled", {
        get() {
            return test();
        },
        configurable: true,
        enumerable: true,
    });
    return logger;
}
let state = "";
if (Deno.permissions) {
    state = (await Deno.permissions.query({
        name: "env",
        variable: "NODE_DEBUG",
    })).state;
}
if (state === "granted") {
    initializeDebugEnv(Deno.env.get("NODE_DEBUG") ?? "");
}
else {
    initializeDebugEnv("");
}
export default { debuglog };
export { debuglog };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiX2RlYnVnbG9nLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiX2RlYnVnbG9nLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxPQUFPLEVBQUUsTUFBTSxxQkFBcUIsQ0FBQztBQUM5QyxPQUFPLEVBQUUsT0FBTyxFQUFFLE1BQU0sWUFBWSxDQUFDO0FBSXJDLElBQUksVUFBd0QsQ0FBQztBQUM3RCxJQUFJLFdBQXFDLENBQUM7QUFHMUMsU0FBUyxrQkFBa0IsQ0FBQyxRQUFnQjtJQUMxQyxVQUFVLEdBQUcsTUFBTSxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsQ0FBQztJQUNqQyxJQUFJLFFBQVEsRUFBRTtRQUVaLFFBQVEsR0FBRyxRQUFRLENBQUMsT0FBTyxDQUFDLG9CQUFvQixFQUFFLE1BQU0sQ0FBQzthQUN0RCxVQUFVLENBQUMsR0FBRyxFQUFFLElBQUksQ0FBQzthQUNyQixVQUFVLENBQUMsR0FBRyxFQUFFLEtBQUssQ0FBQyxDQUFDO1FBQzFCLE1BQU0sYUFBYSxHQUFHLElBQUksTUFBTSxDQUFDLElBQUksUUFBUSxHQUFHLEVBQUUsR0FBRyxDQUFDLENBQUM7UUFDdkQsV0FBVyxHQUFHLENBQUMsR0FBRyxFQUFFLEVBQUUsQ0FBQyxhQUFhLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxLQUFLLElBQUksQ0FBQztLQUN6RDtTQUFNO1FBQ0wsV0FBVyxHQUFHLEdBQUcsRUFBRSxDQUFDLEtBQUssQ0FBQztLQUMzQjtBQUNILENBQUM7QUFJRCxTQUFTLG1CQUFtQixDQUFDLEdBQVc7SUFDdEMsSUFBSSxNQUFNLEtBQUssR0FBRyxJQUFJLE9BQU8sS0FBSyxHQUFHLEVBQUU7UUFDckMsT0FBTyxDQUFDLElBQUksQ0FDViw4Q0FBOEM7WUFDNUMsTUFBTSxHQUFHLEdBQUcsQ0FBQyxXQUFXLEVBQUUsR0FBRyx5QkFBeUI7WUFDdEQsOERBQThEO1lBQzlELHVCQUF1QixDQUMxQixDQUFDO0tBQ0g7QUFDSCxDQUFDO0FB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QyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IHNwcmludGYgfSBmcm9tIFwiLi4vLi4vZm10L3ByaW50Zi50c1wiO1xuaW1wb3J0IHsgaW5zcGVjdCB9IGZyb20gXCIuLi91dGlsLnRzXCI7XG5cbi8vIGBkZWJ1Z0ltcGxzYCBhbmQgYHRlc3RFbmFibGVkYCBhcmUgZGVsaWJlcmF0ZWx5IG5vdCBpbml0aWFsaXplZCBzbyBhbnkgY2FsbFxuLy8gdG8gYGRlYnVnbG9nKClgIGJlZm9yZSBgaW5pdGlhbGl6ZURlYnVnRW52KClgIGlzIGNhbGxlZCB3aWxsIHRocm93LlxubGV0IGRlYnVnSW1wbHM6IFJlY29yZDxzdHJpbmcsICguLi5hcmdzOiB1bmtub3duW10pID0+IHZvaWQ+O1xubGV0IHRlc3RFbmFibGVkOiAoc3RyOiBzdHJpbmcpID0+IGJvb2xlYW47XG5cbi8vIGBkZWJ1Z0VudmAgaXMgaW5pdGlhbCB2YWx1ZSBvZiBwcm9jZXNzLmVudi5OT0RFX0RFQlVHXG5mdW5jdGlvbiBpbml0aWFsaXplRGVidWdFbnYoZGVidWdFbnY6IHN0cmluZykge1xuICBkZWJ1Z0ltcGxzID0gT2JqZWN0LmNyZWF0ZShudWxsKTtcbiAgaWYgKGRlYnVnRW52KSB7XG4gICAgLy8gVGhpcyBpcyBydW4gYmVmb3JlIGFueSB1c2VyIGNvZGUsIGl0J3MgT0sgbm90IHRvIHVzZSBwcmltb3JkaWFscy5cbiAgICBkZWJ1Z0VudiA9IGRlYnVnRW52LnJlcGxhY2UoL1t8XFxcXHt9KClbXFxdXiQrPy5dL2csIFwiXFxcXCQmXCIpXG4gICAgICAucmVwbGFjZUFsbChcIipcIiwgXCIuKlwiKVxuICAgICAgLnJlcGxhY2VBbGwoXCIsXCIsIFwiJHxeXCIpO1xuICAgIGNvbnN0IGRlYnVnRW52UmVnZXggPSBuZXcgUmVnRXhwKGBeJHtkZWJ1Z0Vudn0kYCwgXCJpXCIpO1xuICAgIHRlc3RFbmFibGVkID0gKHN0cikgPT4gZGVidWdFbnZSZWdleC5leGVjKHN0cikgIT09IG51bGw7XG4gIH0gZWxzZSB7XG4gICAgdGVzdEVuYWJsZWQgPSAoKSA9PiBmYWxzZTtcbiAgfVxufVxuXG4vLyBFbWl0cyB3YXJuaW5nIHdoZW4gdXNlciBzZXRzXG4vLyBOT0RFX0RFQlVHPWh0dHAgb3IgTk9ERV9ERUJVRz1odHRwMi5cbmZ1bmN0aW9uIGVtaXRXYXJuaW5nSWZOZWVkZWQoc2V0OiBzdHJpbmcpIHtcbiAgaWYgKFwiSFRUUFwiID09PSBzZXQgfHwgXCJIVFRQMlwiID09PSBzZXQpIHtcbiAgICBjb25zb2xlLndhcm4oXG4gICAgICBcIlNldHRpbmcgdGhlIE5PREVfREVCVUcgZW52aXJvbm1lbnQgdmFyaWFibGUgXCIgK1xuICAgICAgICBcInRvICdcIiArIHNldC50b0xvd2VyQ2FzZSgpICsgXCInIGNhbiBleHBvc2Ugc2Vuc2l0aXZlIFwiICtcbiAgICAgICAgXCJkYXRhIChzdWNoIGFzIHBhc3N3b3JkcywgdG9rZW5zIGFuZCBhdXRoZW50aWNhdGlvbiBoZWFkZXJzKSBcIiArXG4gICAgICAgIFwiaW4gdGhlIHJlc3VsdGluZyBsb2cuXCIsXG4gICAgKTtcbiAgfVxufVxuXG5jb25zdCBub29wID0gKCkgPT4ge307XG5cbmZ1bmN0aW9uIGRlYnVnbG9nSW1wbChcbiAgZW5hYmxlZDogYm9vbGVhbixcbiAgc2V0OiBzdHJpbmcsXG4pOiAoLi4uYXJnczogdW5rbm93bltdKSA9PiB2b2lkIHtcbiAgaWYgKGRlYnVnSW1wbHNbc2V0XSA9PT0gdW5kZWZpbmVkKSB7XG4gICAgaWYgKGVuYWJsZWQpIHtcbiAgICAgIGVtaXRXYXJuaW5nSWZOZWVkZWQoc2V0KTtcbiAgICAgIGRlYnVnSW1wbHNbc2V0XSA9IGZ1bmN0aW9uIGRlYnVnKC4uLmFyZ3M6IHVua25vd25bXSkge1xuICAgICAgICBjb25zdCBtc2cgPSBhcmdzLm1hcCgoYXJnKSA9PiBpbnNwZWN0KGFyZykpLmpvaW4oXCIgXCIpO1xuICAgICAgICBjb25zb2xlLmVycm9yKHNwcmludGYoXCIlcyAlczogJXNcXG5cIiwgc2V0LCBTdHJpbmcoRGVuby5waWQpLCBtc2cpKTtcbiAgICAgIH07XG4gICAgfSBlbHNlIHtcbiAgICAgIGRlYnVnSW1wbHNbc2V0XSA9IG5vb3A7XG4gICAgfVxuICB9XG5cbiAgcmV0dXJuIGRlYnVnSW1wbHNbc2V0XTtcbn1cblxuLy8gZGVidWdsb2dJbXBsIGRlcGVuZHMgb24gcHJvY2Vzcy5waWQgYW5kIHByb2Nlc3MuZW52Lk5PREVfREVCVUcsXG4vLyBzbyBpdCBuZWVkcyB0byBiZSBjYWxsZWQgbGF6aWx5IGluIHRvcCBzY29wZXMgb2YgaW50ZXJuYWwgbW9kdWxlc1xuLy8gdGhhdCBtYXkgYmUgbG9hZGVkIGJlZm9yZSB0aGVzZSBydW4gdGltZSBzdGF0ZXMgYXJlIGFsbG93ZWQgdG9cbi8vIGJlIGFjY2Vzc2VkLlxuZnVuY3Rpb24gZGVidWdsb2coXG4gIHNldDogc3RyaW5nLFxuICBjYjogKGRlYnVnOiAoLi4uYXJnczogdW5rbm93bltdKSA9PiB2b2lkKSA9PiB2b2lkLFxuKSB7XG4gIGZ1bmN0aW9uIGluaXQoKSB7XG4gICAgc2V0ID0gc2V0LnRvVXBwZXJDYXNlKCk7XG4gICAgZW5hYmxlZCA9IHRlc3RFbmFibGVkKHNldCk7XG4gIH1cblxuICBsZXQgZGVidWcgPSAoLi4uYXJnczogdW5rbm93bltdKTogdm9pZCA9PiB7XG4gICAgaW5pdCgpO1xuICAgIC8vIE9ubHkgaW52b2tlcyBkZWJ1Z2xvZ0ltcGwoKSB3aGVuIHRoZSBkZWJ1ZyBmdW5jdGlvbiBpc1xuICAgIC8vIGNhbGxlZCBmb3IgdGhlIGZpcnN0IHRpbWUuXG4gICAgZGVidWcgPSBkZWJ1Z2xvZ0ltcGwoZW5hYmxlZCwgc2V0KTtcblxuICAgIGlmICh0eXBlb2YgY2IgPT09IFwiZnVuY3Rpb25cIikge1xuICAgICAgY2IoZGVidWcpO1xuICAgIH1cblxuICAgIHJldHVybiBkZWJ1ZyguLi5hcmdzKTtcbiAgfTtcblxuICBsZXQgZW5hYmxlZDogYm9vbGVhbjtcbiAgbGV0IHRlc3QgPSAoKSA9PiB7XG4gICAgaW5pdCgpO1xuICAgIHRlc3QgPSAoKSA9PiBlbmFibGVkO1xuICAgIHJldHVybiBlbmFibGVkO1xuICB9O1xuXG4gIGNvbnN0IGxvZ2dlciA9ICguLi5hcmdzOiB1bmtub3duW10pID0+IGRlYnVnKC4uLmFyZ3MpO1xuXG4gIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShsb2dnZXIsIFwiZW5hYmxlZFwiLCB7XG4gICAgZ2V0KCkge1xuICAgICAgcmV0dXJuIHRlc3QoKTtcbiAgICB9LFxuICAgIGNvbmZpZ3VyYWJsZTogdHJ1ZSxcbiAgICBlbnVtZXJhYmxlOiB0cnVlLFxuICB9KTtcblxuICByZXR1cm4gbG9nZ2VyO1xufVxuXG5sZXQgc3RhdGUgPSBcIlwiO1xuXG5pZiAoRGVuby5wZXJtaXNzaW9ucykge1xuICBzdGF0ZSA9IChhd2FpdCBEZW5vLnBlcm1pc3Npb25zLnF1ZXJ5KHtcbiAgICBuYW1lOiBcImVudlwiLFxuICAgIHZhcmlhYmxlOiBcIk5PREVfREVCVUdcIixcbiAgfSkpLnN0YXRlO1xufVxuXG5pZiAoc3RhdGUgPT09IFwiZ3JhbnRlZFwiKSB7XG4gIGluaXRpYWxpemVEZWJ1Z0VudihEZW5vLmVudi5nZXQoXCJOT0RFX0RFQlVHXCIpID8/IFwiXCIpO1xufSBlbHNlIHtcbiAgaW5pdGlhbGl6ZURlYnVnRW52KFwiXCIpO1xufVxuXG5leHBvcnQgZGVmYXVsdCB7IGRlYnVnbG9nIH07XG5cbmV4cG9ydCB7IGRlYnVnbG9nIH07XG4iXX0=