import { join } from "../../../deps.ts";
import { ensureFile } from "../../../deps.ts";
export class Store {
    name;
    path;
    filePath;
    data;
    isInit = false;
    constructor(opts) {
        if (typeof opts === "string") {
            opts = {
                name: opts,
            };
        }
        const { name = ".datastore", path = ".", } = opts || {};
        this.name = name;
        this.path = path.startsWith("/") ? path : join(Deno.cwd(), path);
        this.filePath = join(this.path, name);
    }
    isNullOrEmptyData() {
        return !this.data || !Object.keys(this.data).length;
    }
    async init() {
        if (this.isInit) {
            return;
        }
        await ensureFile(this.filePath);
        const content = new TextDecoder().decode(await Deno.readFile(this.filePath));
        let data = this.data;
        try {
            data = JSON.parse(content);
        }
        catch (_e) {
            data = {};
            await Deno.writeFile(this.filePath, new TextEncoder().encode(JSON.stringify(data, null, 2)), {
                mode: 0o0600,
            });
        }
        this.data = data;
        this.isInit = true;
    }
    async load() {
        if (!this.isInit) {
            await this.init();
        }
    }
    async save() {
        const { data, filePath } = this;
        if (!this.data) {
            return;
        }
        try {
            await Deno.writeFile(filePath, new TextEncoder().encode(JSON.stringify(data, null, 2)), {
                mode: 0o0600,
            });
        }
        catch (e) {
            throw e;
        }
    }
    async get(key) {
        await this.load();
        return this.data[key];
    }
    async set(key, val) {
        await this.load();
        let dataChanged = false;
        if (typeof key === "string") {
            const oldVal = this.data[key];
            if (oldVal !== val) {
                this.data[key] = val;
                dataChanged = true;
            }
        }
        else {
            const keys = Object.keys(key);
            for (const k of keys) {
                const oldVal = this.data[k];
                const val = key[k];
                if (oldVal !== val) {
                    this.data[k] = val;
                    dataChanged = true;
                }
            }
        }
        if (dataChanged) {
            await this.save();
            return true;
        }
        return false;
    }
    async has(key) {
        await this.load();
        return Object.prototype.hasOwnProperty.call(this.data, key);
    }
    async delete(key) {
        if (this.isNullOrEmptyData()) {
            return false;
        }
        await this.load();
        let dataChanged = false;
        if (typeof key === "string") {
            key = [key];
        }
        for (const k of key) {
            if (this.data[k] !== undefined) {
                delete this.data[k];
                dataChanged = true;
            }
        }
        if (dataChanged) {
            await this.save();
            return true;
        }
        return false;
    }
    async clear() {
        if (this.isNullOrEmptyData()) {
            return;
        }
        this.data = {};
        await this.save();
    }
    async toObject() {
        await this.load();
        return this.data;
    }
}
export const directoryExists = async (dir, parent) => {
    for await (const entry of Deno.readDir(parent)) {
        if (entry.isDirectory && entry.name === dir) {
            return true;
        }
    }
    return false;
};
export const mkdir = async (path) => {
    const parent = Deno.cwd();
    const segments = path.replace(parent, "").split("/");
    let exists = true;
    for (let i = 0; i < segments.length; i++) {
        const s = segments[i];
        if (!s || !i && s === ".") {
            continue;
        }
        else if (s === "..") {
            return;
        }
        if (!await directoryExists(s, parent + segments.slice(0, i).join("/"))) {
            exists = false;
            break;
        }
    }
    if (!exists) {
        await Deno.mkdir(path, {
            recursive: true,
        });
        return path;
    }
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoianNvbi1zdG9yZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbImpzb24tc3RvcmUudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLElBQUksRUFBRSxNQUFNLGtCQUFrQixDQUFDO0FBQ3hDLE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSxrQkFBa0IsQ0FBQztBQU85QyxNQUFNLE9BQU8sS0FBSztJQUNULElBQUksQ0FBUztJQUNiLElBQUksQ0FBUztJQUVaLFFBQVEsQ0FBUztJQUNqQixJQUFJLENBQTJCO0lBQy9CLE1BQU0sR0FBRyxLQUFLLENBQUM7SUFDdkIsWUFBWSxJQUE0QjtRQUN0QyxJQUFJLE9BQU8sSUFBSSxLQUFLLFFBQVEsRUFBRTtZQUM1QixJQUFJLEdBQUc7Z0JBQ0wsSUFBSSxFQUFFLElBQUk7YUFDWCxDQUFDO1NBQ0g7UUFFRCxNQUFNLEVBQ0osSUFBSSxHQUFHLFlBQVksRUFDbkIsSUFBSSxHQUFHLEdBQUcsR0FDWCxHQUFHLElBQUksSUFBSSxFQUFFLENBQUM7UUFFZixJQUFJLENBQUMsSUFBSSxHQUFHLElBQUksQ0FBQztRQUNqQixJQUFJLENBQUMsSUFBSSxHQUFHLElBQUksQ0FBQyxVQUFVLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxHQUFHLEVBQUUsRUFBRSxJQUFJLENBQUMsQ0FBQztRQUNqRSxJQUFJLENBQUMsUUFBUSxHQUFHLElBQUksQ0FBQyxJQUFJLENBQUMsSUFBSSxFQUFFLElBQUksQ0FBQyxDQUFDO0lBQ3hDLENBQUM7SUFFTyxpQkFBaUI7UUFDdkIsT0FBTyxDQUFDLElBQUksQ0FBQyxJQUFJLElBQUksQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQyxNQUFNLENBQUM7SUFDdEQsQ0FBQztJQUNNLEtBQUssQ0FBQyxJQUFJO1FBSWYsSUFBSSxJQUFJLENBQUMs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SUFBSSxFQUFFO1lBQ3JCLE9BQU87U0FDUjtRQUVELElBQUksQ0FBQyxNQUFNLGVBQWUsQ0FBQyxDQUFDLEVBQUUsTUFBTSxHQUFHLFFBQVEsQ0FBQyxLQUFLLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQyxFQUFFO1lBQ3RFLE1BQU0sR0FBRyxLQUFLLENBQUM7WUFDZixNQUFNO1NBQ1A7S0FDRjtJQUVELElBQUksQ0FBQyxNQUFNLEVBQUU7UUFDWCxNQUFNLElBQUksQ0FBQyxLQUFLLENBQUMsSUFBSSxFQUFFO1lBQ3JCLFNBQVMsRUFBRSxJQUFJO1NBQ2hCLENBQUMsQ0FBQztRQUNILE9BQU8sSUFBSSxDQUFDO0tBQ2I7QUFDSCxDQUFDLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBqb2luIH0gZnJvbSBcIi4uLy4uLy4uL2RlcHMudHNcIjtcbmltcG9ydCB7IGVuc3VyZUZpbGUgfSBmcm9tIFwiLi4vLi4vLi4vZGVwcy50c1wiO1xuXG5leHBvcnQgaW50ZXJmYWNlIFN0b3JlT3B0aW9ucyB7XG4gIG5hbWU/OiBzdHJpbmc7XG4gIHBhdGg/OiBzdHJpbmc7XG59XG5cbmV4cG9ydCBjbGFzcyBTdG9yZSB7XG4gIHB1YmxpYyBuYW1lOiBzdHJpbmc7XG4gIHB1YmxpYyBwYXRoOiBzdHJpbmc7XG5cbiAgcHJpdmF0ZSBmaWxlUGF0aDogc3RyaW5nO1xuICBwcml2YXRlIGRhdGE/OiBSZWNvcmQ8c3RyaW5nLCB1bmtub3duPjtcbiAgcHJpdmF0ZSBpc0luaXQgPSBmYWxzZTtcbiAgY29uc3RydWN0b3Iob3B0cz86IHN0cmluZyB8IFN0b3JlT3B0aW9ucykge1xuICAgIGlmICh0eXBlb2Ygb3B0cyA9PT0gXCJzdHJpbmdcIikge1xuICAgICAgb3B0cyA9IHtcbiAgICAgICAgbmFtZTogb3B0cyxcbiAgICAgIH07XG4gICAgfVxuXG4gICAgY29uc3Qge1xuICAgICAgbmFtZSA9IFwiLmRhdGFzdG9yZVwiLFxuICAgICAgcGF0aCA9IFwiLlwiLFxuICAgIH0gPSBvcHRzIHx8IHt9O1xuXG4gICAgdGhpcy5uYW1lID0gbmFtZTtcbiAgICB0aGlzLnBhdGggPSBwYXRoLnN0YXJ0c1dpdGgoXCIvXCIpID8gcGF0aCA6IGpvaW4oRGVuby5jd2QoKSwgcGF0aCk7XG4gICAgdGhpcy5maWxlUGF0aCA9IGpvaW4odGhpcy5wYXRoLCBuYW1lKTtcbiAgfVxuXG4gIHByaXZhdGUgaXNOdWxsT3JFbXB0eURhdGEoKSB7XG4gICAgcmV0dXJuICF0aGlzLmRhdGEgfHwgIU9iamVjdC5rZXlzKHRoaXMuZGF0YSkubGVuZ3RoO1xuICB9XG4gIHB1YmxpYyBhc3luYyBpbml0KCkge1xuICAgIC8vIGNoZWNrIGRhdGEganNvbiBpcyBleGlzdHNcbiAgICAvLyBpZiBub3QgZXhpc3RzLCBjcmVhdGUgaXRcbiAgICAvLyBpZiBleGlzdHMsIGxvYWQgaXRcbiAgICBpZiAodGhpcy5pc0luaXQpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgYXdhaXQgZW5zdXJlRmlsZSh0aGlzLmZpbGVQYXRoKTtcbiAgICBjb25zdCBjb250ZW50ID0gbmV3IFRleHREZWNvZGVyKCkuZGVjb2RlKFxuICAgICAgYXdhaXQgRGVuby5yZWFkRmlsZSh0aGlzLmZpbGVQYXRoKSxcbiAgICApO1xuICAgIGxldCBkYXRhID0gdGhpcy5kYXRhO1xuICAgIHRyeSB7XG4gICAgICBkYXRhID0gSlNPTi5wYXJzZShjb250ZW50KTtcbiAgICB9IGNhdGNoIChfZSkge1xuICAgICAgLy8gY2FuJ3QgcGFyc2UganNvblxuICAgICAgZGF0YSA9IHt9O1xuICAgICAgLy8gd3JpdGUgZW1wdHkganNvblxuICAgICAgYXdhaXQgRGVuby53cml0ZUZpbGUoXG4gICAgICAgIHRoaXMuZmlsZVBhdGgsXG4gICAgICAgIG5ldyBUZXh0RW5jb2RlcigpLmVuY29kZShKU09OLnN0cmluZ2lmeShkYXRhLCBudWxsLCAyKSksXG4gICAgICAgIHtcbiAgICAgICAgICBtb2RlOiAwbzA2MDAsXG4gICAgICAgIH0sXG4gICAgICApO1xuICAgIH1cblxuICAgIHRoaXMuZGF0YSA9IGRhdGE7XG4gICAgdGhpcy5pc0luaXQgPSB0cnVlO1xuICB9XG5cbiAgcHJpdmF0ZSBhc3luYyBsb2FkKCkge1xuICAgIGlmICghdGhpcy5pc0luaXQpIHtcbiAgICAgIGF3YWl0IHRoaXMuaW5pdCgpO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgYXN5bmMgc2F2ZSgpIHtcbiAgICBjb25zdCB7IGRhdGEsIGZpbGVQYXRoIH0gPSB0aGlzO1xuXG4gICAgaWYgKCF0aGlzLmRhdGEpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICB0cnkge1xuICAgICAgYXdhaXQgRGVuby53cml0ZUZpbGUoXG4gICAgICAgIGZpbGVQYXRoLFxuICAgICAgICBuZXcgVGV4dEVuY29kZXIoKS5lbmNvZGUoSlNPTi5zdHJpbmdpZnkoZGF0YSwgbnVsbCwgMikpLFxuICAgICAgICB7XG4gICAgICAgICAgbW9kZTogMG8wNjAwLFxuICAgICAgICB9LFxuICAgICAgKTtcbiAgICB9IGNhdGNoIChlKSB7XG4gICAgICB0aHJvdyBlO1xuICAgIH1cbiAgfVxuXG4gIGFzeW5jIGdldChrZXk6IHN0cmluZykge1xuICAgIGF3YWl0IHRoaXMubG9hZCgpO1xuXG4gICAgcmV0dXJuIHRoaXMuZGF0YSFba2V5XTtcbiAgfVxuXG4gIGFzeW5jIHNldChrZXk6IHN0cmluZyB8IHsgW2tleTogc3RyaW5nXTogdW5rbm93biB9LCB2YWw/OiB1bmtub3duKSB7XG4gICAgYXdhaXQgdGhpcy5sb2FkKCk7XG5cbiAgICBsZXQgZGF0YUNoYW5nZWQgPSBmYWxzZTtcblxuICAgIGlmICh0eXBlb2Yga2V5ID09PSBcInN0cmluZ1wiKSB7XG4gICAgICBjb25zdCBvbGRWYWwgPSB0aGlzLmRhdGEhW2tleV07XG5cbiAgICAgIGlmIChvbGRWYWwgIT09IHZhbCkge1xuICAgICAgICB0aGlzLmRhdGEhW2tleV0gPSB2YWw7XG4gICAgICAgIGRhdGFDaGFuZ2VkID0gdHJ1ZTtcbiAgICAgIH1cbiAgICB9IGVsc2Uge1xuICAgICAgY29uc3Qga2V5cyA9IE9iamVjdC5rZXlzKGtleSk7XG5cbiAgICAgIGZvciAoY29uc3QgayBvZiBrZXlzKSB7XG4gICAgICAgIGNvbnN0IG9sZFZhbCA9IHRoaXMuZGF0YSFba107XG4gICAgICAgIGNvbnN0IHZhbCA9IGtleVtrXTtcblxuICAgICAgICBpZiAob2xkVmFsICE9PSB2YWwpIHtcbiAgICAgICAgICB0aGlzLmRhdGEhW2tdID0gdmFsO1xuICAgICAgICAgIGRhdGFDaGFuZ2VkID0gdHJ1ZTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cblxuICAgIGlmIChkYXRhQ2hhbmdlZCkge1xuICAgICAgYXdhaXQgdGhpcy5zYXZlKCk7XG4gICAgICByZXR1cm4gdHJ1ZTtcbiAgICB9XG5cbiAgICByZXR1cm4gZmFsc2U7XG4gIH1cblxuICBhc3luYyBoYXMoa2V5OiBzdHJpbmcpIHtcbiAgICBhd2FpdCB0aGlzLmxvYWQoKTtcbiAgICByZXR1cm4gT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eS5jYWxsKHRoaXMuZGF0YSEsIGtleSk7XG4gIH1cblxuICBhc3luYyBkZWxldGUoa2V5OiBzdHJpbmcgfCBzdHJpbmdbXSkge1xuICAgIGlmICh0aGlzLmlzTnVsbE9yRW1wdHlEYXRhKCkpIHtcbiAgICAgIHJldHVybiBmYWxzZTtcbiAgICB9XG5cbiAgICBhd2FpdCB0aGlzLmxvYWQoKTtcblxuICAgIGxldCBkYXRhQ2hhbmdlZCA9IGZhbHNlO1xuXG4gICAgaWYgKHR5cGVvZiBrZXkgPT09IFwic3RyaW5nXCIpIHtcbiAgICAgIGtleSA9IFtrZXldO1xuICAgIH1cblxuICAgIGZvciAoY29uc3QgayBvZiBrZXkpIHtcbiAgICAgIGlmICh0aGlzLmRhdGEhW2tdICE9PSB1bmRlZmluZWQpIHtcbiAgICAgICAgZGVsZXRlIHRoaXMuZGF0YSFba107XG4gICAgICAgIGRhdGFDaGFuZ2VkID0gdHJ1ZTtcbiAgICAgIH1cbiAgICB9XG5cbiAgICBpZiAoZGF0YUNoYW5nZWQpIHtcbiAgICAgIGF3YWl0IHRoaXMuc2F2ZSgpO1xuICAgICAgcmV0dXJuIHRydWU7XG4gICAgfVxuXG4gICAgcmV0dXJuIGZhbHNlO1xuICB9XG5cbiAgYXN5bmMgY2xlYXIoKSB7XG4gICAgaWYgKHRoaXMuaXNOdWxsT3JFbXB0eURhdGEoKSkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIHRoaXMuZGF0YSA9IHt9O1xuICAgIGF3YWl0IHRoaXMuc2F2ZSgpO1xuICB9XG5cbiAgYXN5bmMgdG9PYmplY3QoKSB7XG4gICAgYXdhaXQgdGhpcy5sb2FkKCk7XG4gICAgcmV0dXJuIHRoaXMuZGF0YSE7XG4gIH1cbn1cbmV4cG9ydCBjb25zdCBkaXJlY3RvcnlFeGlzdHMgPSBhc3luYyAoZGlyOiBzdHJpbmcsIHBhcmVudDogc3RyaW5nKSA9PiB7XG4gIGZvciBhd2FpdCAoY29uc3QgZW50cnkgb2YgRGVuby5yZWFkRGlyKHBhcmVudCkpIHtcbiAgICBpZiAoZW50cnkuaXNEaXJlY3RvcnkgJiYgZW50cnkubmFtZSA9PT0gZGlyKSB7XG4gICAgICByZXR1cm4gdHJ1ZTtcbiAgICB9XG4gIH1cbiAgcmV0dXJuIGZhbHNlO1xufTtcblxuZXhwb3J0IGNvbnN0IG1rZGlyID0gYXN5bmMgKHBhdGg6IHN0cmluZykgPT4ge1xuICBjb25zdCBwYXJlbnQgPSBEZW5vLmN3ZCgpO1xuICBjb25zdCBzZWdtZW50cyA9IHBhdGgucmVwbGFjZShwYXJlbnQsIFwiXCIpLnNwbGl0KFwiL1wiKTtcbiAgbGV0IGV4aXN0cyA9IHRydWU7XG5cbiAgZm9yIChsZXQgaSA9IDA7IGkgPCBzZWdtZW50cy5sZW5ndGg7IGkrKykge1xuICAgIGNvbnN0IHMgPSBzZWdtZW50c1tpXTtcblxuICAgIGlmICghcyB8fCAhaSAmJiBzID09PSBcIi5cIikge1xuICAgICAgY29udGludWU7XG4gICAgfSBlbHNlIGlmIChzID09PSBcIi4uXCIpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICBpZiAoIWF3YWl0IGRpcmVjdG9yeUV4aXN0cyhzLCBwYXJlbnQgKyBzZWdtZW50cy5zbGljZSgwLCBpKS5qb2luKFwiL1wiKSkpIHtcbiAgICAgIGV4aXN0cyA9IGZhbHNlO1xuICAgICAgYnJlYWs7XG4gICAgfVxuICB9XG5cbiAgaWYgKCFleGlzdHMpIHtcbiAgICBhd2FpdCBEZW5vLm1rZGlyKHBhdGgsIHtcbiAgICAgIHJlY3Vyc2l2ZTogdHJ1ZSxcbiAgICB9KTtcbiAgICByZXR1cm4gcGF0aDtcbiAgfVxufTtcbiJdfQ==