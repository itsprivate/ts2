import { get } from "./utils/get.ts";
export function getSourceItemUniqueKey(item, sourceIndex, sourceOptions) {
    const defaultKeysFields = [
        "id",
        "guid",
        "_id",
        "objectId",
        "objectID",
        "ID",
        "url",
        "link",
    ];
    const keyFields = sourceOptions.key
        ? [sourceOptions.key].concat(defaultKeysFields)
        : defaultKeysFields;
    let itemKey;
    for (let keyFieldIndex = 0; keyFieldIndex < keyFields.length; keyFieldIndex++) {
        const keyField = keyFields[keyFieldIndex];
        itemKey = get(item, keyField);
        if (typeof itemKey === "string") {
            break;
        }
    }
    const sourcePrefix = sourceOptions.id || sourceIndex;
    if (itemKey) {
        return `${sourcePrefix}${itemKey}`;
    }
    else {
        return undefined;
    }
}
export function getSourceItemsFromResult(ctx, sourceOptions) {
    const { reporter } = sourceOptions;
    const force = sourceOptions?.force;
    const limit = sourceOptions?.limit;
    let items = ctx.public.result;
    if (sourceOptions.itemsPath) {
        items = get(ctx.public.result, sourceOptions.itemsPath);
    }
    if (!Array.isArray(items)) {
        throw new Error("source result must be an array, but got " + typeof items);
    }
    const finalItems = [];
    for (let itemIndex = 0; itemIndex < items.length; itemIndex++) {
        const item = items[itemIndex];
        if (limit !== undefined && limit > 0 && finalItems.length >= limit) {
            break;
        }
        const key = getSourceItemUniqueKey(item, ctx.public.sourceIndex, sourceOptions);
        if (key === undefined) {
            reporter.warning(`item has no unique key, will be directly added to items`);
        }
        if (key !== undefined && ctx.internalState &&
            (ctx.internalState.keys || []).includes(key) &&
            !force) {
            reporter.debug(`Skip item ${key}, cause it has been processed`);
            continue;
        }
        else if (force) {
            reporter.info(`added processed item: ${key}, cause --force is true`);
        }
        finalItems.push(item);
    }
    ctx.public.items = (ctx.public.items || []).concat(finalItems);
    return ctx;
}
export function filterCtxItems(ctx, filterOptions) {
    const { reporter } = filterOptions;
    const limit = filterOptions?.limit;
    const items = ctx.public.items;
    if (!Array.isArray(items)) {
        throw new Error("ctx.items must be an array, but got " + typeof items + ", filter failed");
    }
    reporter.debug(`Input ${items.length} items`);
    const finalItems = [];
    const finalItemKeys = [];
    const finalItemSourceOptions = [];
    for (let i = 0; i < items.length; i++) {
        if (limit !== undefined && limit > 0 && finalItems.length >= limit) {
            break;
        }
        const item = items[i];
        finalItems.push(item);
    }
    ctx.public.items = finalItems;
    reporter.debug(`Output ${ctx.public.items.length} items`);
    return ctx;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZ2V0LXNvdXJjZS1pdGVtcy1mcm9tLXJlc3VsdC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbImdldC1zb3VyY2UtaXRlbXMtZnJvbS1yZXN1bHQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQ0EsT0FBTyxFQUFFLEdBQUcsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBTXJDLE1BQU0sVUFBVSxzQkFBc0IsQ0FDcEMsSUFBYSxFQUNiLFdBQW1CLEVBQ25CLGFBQTRCO0lBRTVCLE1BQU0saUJBQWlCLEdBQUc7UUFDeEIsSUFBSTtRQUNKLE1BQU07UUFDTixLQUFLO1FBQ0wsVUFBVTtRQUNWLFVBQVU7UUFDVixJQUFJO1FBQ0osS0FBSztRQUNMLE1BQU07S0FDUCxDQUFDO0lBQ0YsTUFBTSxTQUFTLEdBQUcsYUFBYSxDQUFDLEdBQUc7UUFDakMsQ0FBQyxDQUFDLENBQUMsYUFBYSxDQUFDLEdBQUcsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxpQkFBaUIsQ0FBQztRQUMvQyxDQUFDLENBQUMsaUJBQWlCLENBQUM7SUFFdEIsSUFBSSxPQUFPLENBQUM7SUFDWixLQUNFLElBQUksYUFBYSxHQUFHLENBQUMsRUFDckIsYUFBYSxHQUFHLFNBQVMsQ0FBQyxNQUFNLEVBQ2hDLGFBQWEsRUFBRSxFQUNmO1FBQ0EsTUFBTSxRQUFRLEdBQUcsU0FBUyxDQUFDLGFBQWEsQ0FBQyxDQUFDO1FBQzFDLE9BQU8sR0FBRyxHQUFHLENBQUMsSUFBSSxFQUFFLFFBQVEsQ0FBQyxDQUFDO1FBQzlCLElBQUksT0FBTyxPQUFPLEtBQUssUUFBUSxFQUFFO1lBQy9CLE1BQU07U0FDUDtLQUNGO0lBQ0QsTUFBTSxZQUFZLEdBQUcsYUFBYSxDQUFDLEVBQUUsSUFBSSxXQUFXLENBQUM7SUFDckQsSUFBSSxPQUFPLEVBQUU7UUFDWCxPQUFPLEdBQUcsWUFBWSxHQUFHLE9BQU8sRUFBRSxDQUFDO0tBQ3BDO1NBQU07UUFDTCxPQUFPLFNBQVMsQ0FBQztLQUNsQjtBQUNILENBQUM7QUFD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LENBQUM7SUFDbEMsS0FBSyxJQUFJLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxHQUFHLEtBQUssQ0FBQyxNQUFNLEVBQUUsQ0FBQyxFQUFFLEVBQUU7UUFHckMsSUFDRSxLQUFLLEtBQUssU0FBUyxJQUFJLEtBQUssR0FBRyxDQUFDLElBQUksVUFBVSxDQUFDLE1BQU0sSUFBSSxLQUFLLEVBQzlEO1lBQ0EsTUFBTTtTQUNQO1FBQ0QsTUFBTSxJQUFJLEdBQUcsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDO1FBRXRCLFVBQVUsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUM7S0FDdkI7SUFFRCxHQUFHLENBQUMsTUFBTSxDQUFDLEtBQUssR0FBRyxVQUFVLENBQUM7SUFFOUIsUUFBUSxDQUFDLEtBQUssQ0FBQyxVQUFVLEdBQUcsQ0FBQyxNQUFNLENBQUMsS0FBSyxDQUFDLE1BQU0sUUFBUSxDQUFDLENBQUM7SUFFMUQsT0FBTyxHQUFHLENBQUM7QUFDYixDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgU291cmNlT3B0aW9ucyB9IGZyb20gXCIuL2ludGVyZmFjZS50c1wiO1xuaW1wb3J0IHsgZ2V0IH0gZnJvbSBcIi4vdXRpbHMvZ2V0LnRzXCI7XG5pbXBvcnQgeyBsb2cgfSBmcm9tIFwiLi4vLi4vZGVwcy50c1wiO1xuaW1wb3J0IHsgQ29udGV4dCB9IGZyb20gXCIuL2ludGVybmFsLWludGVyZmFjZS50c1wiO1xuaW50ZXJmYWNlIEZpbHRlclRyaWdnZXJPcHRpb24gZXh0ZW5kcyBTb3VyY2VPcHRpb25zIHtcbiAgcmVwb3J0ZXI6IGxvZy5Mb2dnZXI7XG59XG5leHBvcnQgZnVuY3Rpb24gZ2V0U291cmNlSXRlbVVuaXF1ZUtleShcbiAgaXRlbTogdW5rbm93bixcbiAgc291cmNlSW5kZXg6IG51bWJlcixcbiAgc291cmNlT3B0aW9uczogU291cmNlT3B0aW9ucyxcbik6IHN0cmluZyB8IHVuZGVmaW5lZCB7XG4gIGNvbnN0IGRlZmF1bHRLZXlzRmllbGRzID0gW1xuICAgIFwiaWRcIixcbiAgICBcImd1aWRcIixcbiAgICBcIl9pZFwiLFxuICAgIFwib2JqZWN0SWRcIixcbiAgICBcIm9iamVjdElEXCIsXG4gICAgXCJJRFwiLFxuICAgIFwidXJsXCIsXG4gICAgXCJsaW5rXCIsXG4gIF07XG4gIGNvbnN0IGtleUZpZWxkcyA9IHNvdXJjZU9wdGlvbnMua2V5XG4gICAgPyBbc291cmNlT3B0aW9ucy5rZXldLmNvbmNhdChkZWZhdWx0S2V5c0ZpZWxkcylcbiAgICA6IGRlZmF1bHRLZXlzRmllbGRzO1xuICAvLyB1bmlxdWUga2V5XG4gIGxldCBpdGVtS2V5O1xuICBmb3IgKFxuICAgIGxldCBrZXlGaWVsZEluZGV4ID0gMDtcbiAgICBrZXlGaWVsZEluZGV4IDwga2V5RmllbGRzLmxlbmd0aDtcbiAgICBrZXlGaWVsZEluZGV4KytcbiAgKSB7XG4gICAgY29uc3Qga2V5RmllbGQgPSBrZXlGaWVsZHNba2V5RmllbGRJbmRleF07XG4gICAgaXRlbUtleSA9IGdldChpdGVtLCBrZXlGaWVsZCk7XG4gICAgaWYgKHR5cGVvZiBpdGVtS2V5ID09PSBcInN0cmluZ1wiKSB7XG4gICAgICBicmVhaztcbiAgICB9XG4gIH1cbiAgY29uc3Qgc291cmNlUHJlZml4ID0gc291cmNlT3B0aW9ucy5pZCB8fCBzb3VyY2VJbmRleDtcbiAgaWYgKGl0ZW1LZXkpIHtcbiAgICByZXR1cm4gYCR7c291cmNlUHJlZml4fSR7aXRlbUtleX1gO1xuICB9IGVsc2Uge1xuICAgIHJldHVybiB1bmRlZmluZWQ7XG4gIH1cbn1cbmV4cG9ydCBmdW5jdGlvbiBnZXRTb3VyY2VJdGVtc0Zyb21SZXN1bHQoXG4gIGN0eDogQ29udGV4dCxcbiAgc291cmNlT3B0aW9uczogRmlsdGVyVHJpZ2dlck9wdGlvbixcbik6IENvbnRleHQge1xuICBjb25zdCB7IHJlcG9ydGVyIH0gPSBzb3VyY2VPcHRpb25zO1xuICAvLyBmb3JtYXRcbiAgY29uc3QgZm9yY2UgPSBzb3VyY2VPcHRpb25zPy5mb3JjZTtcblxuICBjb25zdCBsaW1pdCA9IHNvdXJjZU9wdGlvbnM/LmxpbWl0O1xuICAvLyBnZXQgaXRlbXMgcGF0aCwgZ2V0IGRlZHVwbGljYXRpb24ga2V5XG4gIGxldCBpdGVtcyA9IGN0eC5wdWJsaWMucmVzdWx0O1xuXG4gIGlmIChzb3VyY2VPcHRpb25zLml0ZW1zUGF0aCkge1xuICAgIGl0ZW1zID0gZ2V0KFxuICAgICAgY3R4LnB1YmxpYy5yZXN1bHQgYXMgUmVjb3JkPHN0cmluZywgdW5rbm93bj4sXG4gICAgICBzb3VyY2VPcHRpb25zLml0ZW1zUGF0aCxcbiAgICApO1xuICB9XG5cbiAgaWYgKCFBcnJheS5pc0FycmF5KGl0ZW1zKSkge1xuICAgIHRocm93IG5ldyBFcnJvcihcInNvdXJjZSByZXN1bHQgbXVzdCBiZSBhbiBhcnJheSwgYnV0IGdvdCBcIiArIHR5cGVvZiBpdGVtcyk7XG4gIH1cblxuICBjb25zdCBmaW5hbEl0ZW1zID0gW107XG4gIGZvciAobGV0IGl0ZW1JbmRleCA9IDA7IGl0ZW1JbmRleCA8IGl0ZW1zLmxlbmd0aDsgaXRlbUluZGV4KyspIHtcbiAgICAvLyByZWFjaCBtYXggaXRlbXNcbiAgICBjb25zdCBpdGVtID0gaXRlbXNbaXRlbUluZGV4XTtcbiAgICBpZiAoXG4gICAgICBsaW1pdCAhPT0gdW5kZWZpbmVkICYmIGxpbWl0ID4gMCAmJiBmaW5hbEl0ZW1zLmxlbmd0aCA+PSBsaW1pdFxuICAgICkge1xuICAgICAgYnJlYWs7XG4gICAgfVxuICAgIGNvbnN0IGtleSA9IGdldFNvdXJjZUl0ZW1VbmlxdWVLZXkoXG4gICAgICBpdGVtLFxuICAgICAgY3R4LnB1YmxpYy5zb3VyY2VJbmRleCEsXG4gICAgICBzb3VyY2VPcHRpb25zLFxuICAgICk7XG4gICAgaWYgKGtleSA9PT0gdW5kZWZpbmVkKSB7XG4gICAgICByZXBvcnRlci53YXJuaW5nKFxuICAgICAgICBgaXRlbSBoYXMgbm8gdW5pcXVlIGtleSwgd2lsbCBiZSBkaXJlY3RseSBhZGRlZCB0byBpdGVtc2AsXG4gICAgICApO1xuICAgIH1cblxuICAgIGlmIChcbiAgICAgIGtleSAhPT0gdW5kZWZpbmVkICYmIGN0eC5pbnRlcm5hbFN0YXRlICYmXG4gICAgICAoY3R4LmludGVybmFsU3RhdGUua2V5cyB8fCBbXSkuaW5jbHVkZXMoa2V5KSAmJlxuICAgICAgIWZvcmNlXG4gICAgKSB7XG4gICAgICByZXBvcnRlci5kZWJ1ZyhgU2tpcCBpdGVtICR7a2V5fSwgY2F1c2UgaXQgaGFzIGJlZW4gcHJvY2Vzc2VkYCk7XG4gICAgICBjb250aW51ZTtcbiAgICB9IGVsc2UgaWYgKGZvcmNlKSB7XG4gICAgICByZXBvcnRlci5pbmZvKGBhZGRlZCBwcm9jZXNzZWQgaXRlbTogJHtrZXl9LCBjYXVzZSAtLWZvcmNlIGlzIHRydWVgKTtcbiAgICB9XG5cbiAgICBmaW5hbEl0ZW1zLnB1c2goaXRlbSk7XG4gIH1cbiAgLy8gc2F2ZSBjdXJyZW50IGtleSB0byBkYlxuICBjdHgucHVibGljLml0ZW1zID0gKGN0eC5wdWJsaWMuaXRlbXMgfHwgW10pLmNvbmNhdChmaW5hbEl0ZW1zKTtcblxuICByZXR1cm4gY3R4O1xufVxuXG5leHBvcnQgZnVuY3Rpb24gZmlsdGVyQ3R4SXRlbXMoXG4gIGN0eDogQ29udGV4dCxcbiAgZmlsdGVyT3B0aW9uczogRmlsdGVyVHJpZ2dlck9wdGlvbixcbik6IENvbnRleHQge1xuICBjb25zdCB7IHJlcG9ydGVyIH0gPSBmaWx0ZXJPcHRpb25zO1xuICAvLyBmb3JtYXRcbiAgY29uc3QgbGltaXQgPSBmaWx0ZXJPcHRpb25zPy5saW1pdDtcbiAgLy8gZ2V0IGl0ZW1zIHBhdGgsIGdldCBkZWR1cGxpY2F0aW9uIGtleVxuICBjb25zdCBpdGVtcyA9IGN0eC5wdWJsaWMuaXRlbXM7XG5cbiAgaWYgKCFBcnJheS5pc0FycmF5KGl0ZW1zKSkge1xuICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgIFwiY3R4Lml0ZW1zIG11c3QgYmUgYW4gYXJyYXksIGJ1dCBnb3QgXCIgKyB0eXBlb2YgaXRlbXMgKyBcIiwgZmlsdGVyIGZhaWxlZFwiLFxuICAgICk7XG4gIH1cbiAgcmVwb3J0ZXIuZGVidWcoYElucHV0ICR7aXRlbXMubGVuZ3RofSBpdGVtc2ApO1xuXG4gIGNvbnN0IGZpbmFsSXRlbXMgPSBbXTtcbiAgY29uc3QgZmluYWxJdGVtS2V5cyA9IFtdO1xuICBjb25zdCBmaW5hbEl0ZW1Tb3VyY2VPcHRpb25zID0gW107XG4gIGZvciAobGV0IGkgPSAwOyBpIDwgaXRlbXMubGVuZ3RoOyBpKyspIHtcbiAgICAvLyByZWFjaCBtYXggaXRlbXNcblxuICAgIGlmIChcbiAgICAgIGxpbWl0ICE9PSB1bmRlZmluZWQgJiYgbGltaXQgPiAwICYmIGZpbmFsSXRlbXMubGVuZ3RoID49IGxpbWl0XG4gICAgKSB7XG4gICAgICBicmVhaztcbiAgICB9XG4gICAgY29uc3QgaXRlbSA9IGl0ZW1zW2ldO1xuXG4gICAgZmluYWxJdGVtcy5wdXNoKGl0ZW0pO1xuICB9XG4gIC8vIHNhdmUgY3VycmVudCBrZXkgdG8gZGJcbiAgY3R4LnB1YmxpYy5pdGVtcyA9IGZpbmFsSXRlbXM7XG5cbiAgcmVwb3J0ZXIuZGVidWcoYE91dHB1dCAke2N0eC5wdWJsaWMuaXRlbXMubGVuZ3RofSBpdGVtc2ApO1xuXG4gIHJldHVybiBjdHg7XG59XG4iXX0=