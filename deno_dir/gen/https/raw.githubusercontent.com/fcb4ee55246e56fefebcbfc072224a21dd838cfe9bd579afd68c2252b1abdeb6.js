import { StepType } from "./internal-interface.ts";
import { get } from "./utils/get.ts";
import { getFrom } from "./get-from.ts";
import { runScript } from "./utils/run-script.ts";
export function getStepResponse(ctx) {
    return {
        result: ctx.public.result,
        ok: ctx.public.ok,
        isRealOk: ctx.public.isRealOk,
        error: ctx.public.error,
        cmdResult: ctx.public.cmdResult,
        cmdCode: ctx.public.cmdCode,
        cmdOk: ctx.public.cmdOk,
        cmdError: ctx.public.cmdError,
    };
}
export function setOkResult(ctx, stepResult) {
    ctx.public.result = stepResult;
    ctx.public.ok = true;
    ctx.public.isRealOk = true;
    ctx.public.error = undefined;
    return ctx;
}
export function setErrorResult(ctx, error) {
    ctx.public.result = undefined;
    ctx.public.error = error;
    ctx.public.isRealOk = false;
    ctx.public.ok = false;
    if (error.code !== undefined) {
        ctx.public.cmdCode = error.code;
        ctx.public.cmdError = error.message;
        ctx.public.cmdOk = false;
        ctx.public.cmdResult = undefined;
    }
    return ctx;
}
export async function runStep(ctx, step) {
    const currentStepType = ctx.currentStepType;
    const { reporter } = step;
    if (currentStepType === StepType.Source) {
        reporter.debug(`Source Options: ${JSON.stringify(step, null, 2)}`);
    }
    else if (currentStepType === StepType.Filter) {
        reporter.debug(`Filter Options: ${JSON.stringify(step, null, 2)}`);
    }
    else if (currentStepType === StepType.Step) {
        reporter.debug(`Step receive item: ${JSON.stringify(ctx.public.item, null, 2)}`);
        reporter.debug(`Step Options: ${JSON.stringify(step, null, 2)}`);
    }
    if (step.env) {
        for (const key in step.env) {
            const value = step.env[key];
            if (typeof value === "string") {
                Deno.env.set(key, value);
            }
        }
    }
    let stepResult;
    try {
        const from = step.from;
        let use;
        if (from) {
            const lib = await getFrom(ctx, from, reporter);
            use = get(lib, step.use ?? "default");
        }
        else if (step.use &&
            typeof globalThis[step.use] === "function") {
            use = globalThis[step.use];
        }
        else if (step.use && step.use.startsWith("Deno.")) {
            const denoApiMethod = step.use.replace("Deno.", "");
            use = get(Deno, denoApiMethod);
        }
        else if (step.use) {
            throw new Error(`${step.use} is not a function`);
        }
        const args = step.args || [];
        if (typeof use === "function") {
            reporter.debug(`Run ${use.name} with args: ${JSON.stringify(args, null, 2)}`);
            stepResult = await use(...args);
            ctx = setOkResult(ctx, stepResult);
            reporter.debug(`use: result: ${typeof stepResult === "string"
                ? stepResult
                : JSON.stringify(stepResult, null, 2)}`);
        }
        else if (use !== undefined) {
            const e = "`use` must be a function, but got " + typeof use;
            throw new Error(e);
        }
    }
    catch (e) {
        reporter.warning(`Failed to run use`);
        throw new Error(e);
    }
    if (step.run) {
        try {
            const scriptResult = await runScript(step.run, {
                ctx: ctx.public,
            });
            stepResult = scriptResult.result;
            ctx = setOkResult(ctx, stepResult);
            ctx.public.state = scriptResult.ctx.state;
            reporter.debug(`Run script result: ${typeof stepResult === "string"
                ? stepResult
                : JSON.stringify(stepResult, null, 2)}`);
        }
        catch (e) {
            reporter.warning(`Failed to run script`);
            throw new Error(e);
        }
    }
    ctx.public.ok = true;
    return ctx;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicnVuLXN0ZXAuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJydW4tc3RlcC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFDQSxPQUFPLEVBQVcsUUFBUSxFQUFFLE1BQU0seUJBQXlCLENBQUM7QUFFNUQsT0FBTyxFQUFFLEdBQUcsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBQ3JDLE9BQU8sRUFBRSxPQUFPLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDeEMsT0FBTyxFQUFFLFNBQVMsRUFBRSxNQUFNLHVCQUF1QixDQUFDO0FBS2xELE1BQU0sVUFBVSxlQUFlLENBQUMsR0FBWTtJQUMxQyxPQUFPO1FBQ0wsTUFBTSxFQUFFLEdBQUcsQ0FBQyxNQUFNLENBQUMsTUFBTTtRQUN6QixFQUFFLEVBQUUsR0FBRyxDQUFDLE1BQU0sQ0FBQyxFQUFHO1FBQ2xCLFFBQVEsRUFBRSxHQUFHLENBQUMsTUFBTSxDQUFDLFFBQVM7UUFDOUIsS0FBSyxFQUFFLEdBQUcsQ0FBQyxNQUFNLENBQUMsS0FBSztRQUN2QixTQUFTLEVBQUUsR0FBRyxDQUFDLE1BQU0sQ0FBQyxTQUFTO1FBQy9CLE9BQU8sRUFBRSxHQUFHLENBQUMsTUFBTSxDQUFDLE9BQU87UUFDM0IsS0FBSyxFQUFFLEdBQUcsQ0FBQyxNQUFNLENBQUMsS0FBSztRQUN2QixRQUFRLEVBQUUsR0FBRyxDQUFDLE1BQU0sQ0FBQyxRQUFRO0tBQzlCLENBQUM7QUFDSixDQUFDO0FBQ0QsTUFBTSxVQUFVLFdBQVcsQ0FBQyxHQUFZLEVBQUUsVUFBbUI7SUFDM0QsR0FBRyxDQUFDLE1BQU0sQ0FBQyxNQUFNLEdBQUcsVUFBVSxDQUFDO0lBQy9CLEdBQUcsQ0FBQyxNQUFNLENBQUMsRUFBRSxHQUFHLElBQUksQ0FBQztJQUNyQixHQUFHLENBQUMsTUFBTSxDQUFDLFFBQVEsR0FBRyxJQUFJLENBQUM7SUFDM0IsR0FBRyxDQUFDLE1BQU0sQ0FBQyxLQUFLLEdBQUcsU0FBUyxDQUFDO0lBQzdCLE9BQU8sR0FBRyxD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WUFDNUQsTUFBTSxJQUFJLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQztTQUNwQjtLQUNGO0lBQUMsT0FBTyxDQUFDLEVBQUU7UUFDVixRQUFRLENBQUMsT0FBTyxDQUNkLG1CQUFtQixDQUNwQixDQUFDO1FBQ0YsTUFBTSxJQUFJLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQztLQUNwQjtJQUdELElBQUksSUFBSSxDQUFDLEdBQUcsRUFBRTtRQUVaLElBQUk7WUFDRixNQUFNLFlBQVksR0FBRyxNQUFNLFNBQVMsQ0FBQyxJQUFJLENBQUMsR0FBRyxFQUFFO2dCQUM3QyxHQUFHLEVBQUUsR0FBRyxDQUFDLE1BQU07YUFDaEIsQ0FBQyxDQUFDO1lBRUgsVUFBVSxHQUFHLFlBQVksQ0FBQyxNQUFNLENBQUM7WUFDakMsR0FBRyxHQUFHLFdBQVcsQ0FBQyxHQUFHLEVBQUUsVUFBVSxDQUFDLENBQUM7WUFDbkMsR0FBRyxDQUFDLE1BQU0sQ0FBQyxLQUFLLEdBQUcsWUFBWSxDQUFDLEdBQUcsQ0FBQyxLQUFLLENBQUM7WUFDMUMsUUFBUSxDQUFDLEtBQUssQ0FDWixzQkFDRSxPQUFPLFVBQVUsS0FBSyxRQUFRO2dCQUM1QixDQUFDLENBQUMsVUFBVTtnQkFDWixDQUFDLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxVQUFVLEVBQUUsSUFBSSxFQUFFLENBQUMsQ0FDeEMsRUFBRSxDQUNILENBQUM7U0FDSDtRQUFDLE9BQU8sQ0FBQyxFQUFFO1lBQ1YsUUFBUSxDQUFDLE9BQU8sQ0FDZCxzQkFBc0IsQ0FDdkIsQ0FBQztZQUNGLE1BQU0sSUFBSSxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUM7U0FDcEI7S0FDRjtJQUVELEdBQUcsQ0FBQyxNQUFNLENBQUMsRUFBRSxHQUFHLElBQUksQ0FBQztJQUNyQixPQUFPLEdBQUcsQ0FBQztBQUNiLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBTdGVwT3B0aW9ucywgU3RlcFJlc3BvbnNlIH0gZnJvbSBcIi4vaW50ZXJmYWNlLnRzXCI7XG5pbXBvcnQgeyBDb250ZXh0LCBTdGVwVHlwZSB9IGZyb20gXCIuL2ludGVybmFsLWludGVyZmFjZS50c1wiO1xuaW1wb3J0IHsgbG9nIH0gZnJvbSBcIi4uLy4uL2RlcHMudHNcIjtcbmltcG9ydCB7IGdldCB9IGZyb20gXCIuL3V0aWxzL2dldC50c1wiO1xuaW1wb3J0IHsgZ2V0RnJvbSB9IGZyb20gXCIuL2dldC1mcm9tLnRzXCI7XG5pbXBvcnQgeyBydW5TY3JpcHQgfSBmcm9tIFwiLi91dGlscy9ydW4tc2NyaXB0LnRzXCI7XG5cbmludGVyZmFjZSBSdW5TdGVwT3B0aW9uIGV4dGVuZHMgU3RlcE9wdGlvbnMge1xuICByZXBvcnRlcjogbG9nLkxvZ2dlcjtcbn1cbmV4cG9ydCBmdW5jdGlvbiBnZXRTdGVwUmVzcG9uc2UoY3R4OiBDb250ZXh0KTogU3RlcFJlc3BvbnNlIHtcbiAgcmV0dXJuIHtcbiAgICByZXN1bHQ6IGN0eC5wdWJsaWMucmVzdWx0LFxuICAgIG9rOiBjdHgucHVibGljLm9rISxcbiAgICBpc1JlYWxPazogY3R4LnB1YmxpYy5pc1JlYWxPayEsXG4gICAgZXJyb3I6IGN0eC5wdWJsaWMuZXJyb3IsXG4gICAgY21kUmVzdWx0OiBjdHgucHVibGljLmNtZFJlc3VsdCxcbiAgICBjbWRDb2RlOiBjdHgucHVibGljLmNtZENvZGUsXG4gICAgY21kT2s6IGN0eC5wdWJsaWMuY21kT2ssXG4gICAgY21kRXJyb3I6IGN0eC5wdWJsaWMuY21kRXJyb3IsXG4gIH07XG59XG5leHBvcnQgZnVuY3Rpb24gc2V0T2tSZXN1bHQoY3R4OiBDb250ZXh0LCBzdGVwUmVzdWx0OiB1bmtub3duKTogQ29udGV4dCB7XG4gIGN0eC5wdWJsaWMucmVzdWx0ID0gc3RlcFJlc3VsdDtcbiAgY3R4LnB1YmxpYy5vayA9IHRydWU7XG4gIGN0eC5wdWJsaWMuaXNSZWFsT2sgPSB0cnVlO1xuICBjdHgucHVibGljLmVycm9yID0gdW5kZWZpbmVkO1xuICByZXR1cm4gY3R4O1xufVxuZXhwb3J0IGZ1bmN0aW9uIHNldEVycm9yUmVzdWx0KGN0eDogQ29udGV4dCwgZXJyb3I6IHVua25vd24pOiBDb250ZXh0IHtcbiAgY3R4LnB1YmxpYy5yZXN1bHQgPSB1bmRlZmluZWQ7XG4gIGN0eC5wdWJsaWMuZXJyb3IgPSBlcnJvcjtcbiAgY3R4LnB1YmxpYy5pc1JlYWxPayA9IGZhbHNlO1xuICBjdHgucHVibGljLm9rID0gZmFsc2U7XG4gIGlmICgoZXJyb3IgYXMgUmVjb3JkPHN0cmluZywgdW5rbm93bj4pLmNvZGUgIT09IHVuZGVmaW5lZCkge1xuICAgIGN0eC5wdWJsaWMuY21kQ29kZSA9IChlcnJvciBhcyBSZWNvcmQ8c3RyaW5nLCB1bmtub3duPikuY29kZSBhcyBudW1iZXI7XG4gICAgY3R4LnB1YmxpYy5jbWRFcnJvciA9IChlcnJvciBhcyBSZWNvcmQ8c3RyaW5nLCB1bmtub3duPikubWVzc2FnZSBhcyBzdHJpbmc7XG4gICAgY3R4LnB1YmxpYy5jbWRPayA9IGZhbHNlO1xuICAgIGN0eC5wdWJsaWMuY21kUmVzdWx0ID0gdW5kZWZpbmVkO1xuICB9XG4gIHJldHVybiBjdHg7XG59XG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gcnVuU3RlcChcbiAgY3R4OiBDb250ZXh0LFxuICBzdGVwOiBSdW5TdGVwT3B0aW9uLFxuKTogUHJvbWlzZTxDb250ZXh0PiB7XG4gIGNvbnN0IGN1cnJlbnRTdGVwVHlwZSA9IGN0eC5jdXJyZW50U3RlcFR5cGU7XG4gIGNvbnN0IHsgcmVwb3J0ZXIgfSA9IHN0ZXA7XG4gIC8vIGNsZWFyIHRlbXAgc3RhdGVcbiAgaWYgKGN1cnJlbnRTdGVwVHlwZSA9PT0gU3RlcFR5cGUuU291cmNlKSB7XG4gICAgcmVwb3J0ZXIuZGVidWcoXG4gICAgICBgU291cmNlIE9wdGlvbnM6ICR7SlNPTi5zdHJpbmdpZnkoc3RlcCwgbnVsbCwgMil9YCxcbiAgICApO1xuICB9IGVsc2UgaWYgKGN1cnJlbnRTdGVwVHlwZSA9PT0gU3RlcFR5cGUuRmlsdGVyKSB7XG4gICAgcmVwb3J0ZXIuZGVidWcoXG4gICAgICBgRmlsdGVyIE9wdGlvbnM6ICR7SlNPTi5zdHJpbmdpZnkoc3RlcCwgbnVsbCwgMil9YCxcbiAgICApO1xuICB9IGVsc2UgaWYgKGN1cnJlbnRTdGVwVHlwZSA9PT0gU3RlcFR5cGUuU3RlcCkge1xuICAgIHJlcG9ydGVyLmRlYnVnKFxuICAgICAgYFN0ZXAgcmVjZWl2ZSBpdGVtOiAke0pTT04uc3RyaW5naWZ5KGN0eC5wdWJsaWMuaXRlbSwgbnVsbCwgMil9YCxcbiAgICApO1xuICAgIHJlcG9ydGVyLmRlYnVnKFxuICAgICAgYFN0ZXAgT3B0aW9uczogJHtKU09OLnN0cmluZ2lmeShzdGVwLCBudWxsLCAyKX1gLFxuICAgICk7XG4gIH1cblxuICAvLyBwYXJzZSBlbnYgdG8gZW52XG4gIGlmIChzdGVwLmVudikge1xuICAgIGZvciAoY29uc3Qga2V5IGluIHN0ZXAuZW52KSB7XG4gICAgICBjb25zdCB2YWx1ZSA9IHN0ZXAuZW52W2tleV07XG4gICAgICBpZiAodHlwZW9mIHZhbHVlID09PSBcInN0cmluZ1wiKSB7XG4gICAgICAgIERlbm8uZW52LnNldChrZXksIHZhbHVlKTtcbiAgICAgIH1cbiAgICB9XG4gIH1cbiAgbGV0IHN0ZXBSZXN1bHQ7XG5cbiAgdHJ5IHtcbiAgICBjb25zdCBmcm9tID0gc3RlcC5mcm9tO1xuICAgIGxldCB1c2U7XG4gICAgaWYgKGZyb20pIHtcbiAgICAgIGNvbnN0IGxpYiA9IGF3YWl0IGdldEZyb20oY3R4LCBmcm9tLCByZXBvcnRlcik7ICAgICAgXG4gICAgICB1c2UgPSBnZXQobGliLCBzdGVwLnVzZSA/PyBcImRlZmF1bHRcIik7XG4gICAgfSBlbHNlIGlmIChcbiAgICAgIHN0ZXAudXNlICYmXG4gICAgICB0eXBlb2YgKGdsb2JhbFRoaXMgYXMgUmVjb3JkPHN0cmluZywgdW5rbm93bj4pW3N0ZXAudXNlXSA9PT0gXCJmdW5jdGlvblwiXG4gICAgKSB7XG4gICAgICAvLyBUT0RPIGNoZWNrIGRlZmF1bHQgYXBwXG4gICAgICB1c2UgPSAoZ2xvYmFsVGhpcyBhcyBSZWNvcmQ8c3RyaW5nLCB1bmtub3duPilbc3RlcC51c2VdO1xuICAgIH1lbHNlIGlmKHN0ZXAudXNlICYmIHN0ZXAudXNlLnN0YXJ0c1dpdGgoXCJEZW5vLlwiKSl7XG4gICAgICBjb25zdCBkZW5vQXBpTWV0aG9kID0gc3RlcC51c2UucmVwbGFjZShcIkRlbm8uXCIsIFwiXCIpO1xuICAgICAgdXNlID0gZ2V0KERlbm8sIGRlbm9BcGlNZXRob2QpO1xuICAgICAgXG4gICAgfWVsc2UgaWYoc3RlcC51c2Upe1xuICAgICAgdGhyb3cgbmV3IEVycm9yKGAke3N0ZXAudXNlfSBpcyBub3QgYSBmdW5jdGlvbmApO1xuICAgIH1cblxuICAgIGNvbnN0IGFyZ3MgPSBzdGVwLmFyZ3MgfHwgW107XG5cbiAgICAvLyBUT0RPIGNoZWNrIGlmIHByb21pc2VzXG4gICAgaWYgKHR5cGVvZiB1c2UgPT09IFwiZnVuY3Rpb25cIikge1xuICAgICAgcmVwb3J0ZXIuZGVidWcoXG4gICAgICAgIGBSdW4gJHt1c2UubmFtZX0gd2l0aCBhcmdzOiAke0pTT04uc3RyaW5naWZ5KGFyZ3MsIG51bGwsIDIpfWAsXG4gICAgICApO1xuICAgICAgICBcbiAgICAgIHN0ZXBSZXN1bHQgPSBhd2FpdCB1c2UoLi4uYXJncyk7ICAgICAgXG4gICAgICBjdHggPSBzZXRPa1Jlc3VsdChjdHgsIHN0ZXBSZXN1bHQpO1xuXG4gICAgICByZXBvcnRlci5kZWJ1ZyhcbiAgICAgICAgYHVzZTogcmVzdWx0OiAke1xuICAgICAgICAgIHR5cGVvZiBzdGVwUmVzdWx0ID09PSBcInN0cmluZ1wiXG4gICAgICAgICAgICA/IHN0ZXBSZXN1bHRcbiAgICAgICAgICAgIDogSlNPTi5zdHJpbmdpZnkoc3RlcFJlc3VsdCwgbnVsbCwgMilcbiAgICAgICAgfWAsXG4gICAgICApO1xuICAgIH0gZWxzZSBpZiAodXNlICE9PSB1bmRlZmluZWQpIHtcbiAgICAgIGNvbnN0IGUgPSBcImB1c2VgIG11c3QgYmUgYSBmdW5jdGlvbiwgYnV0IGdvdCBcIiArIHR5cGVvZiB1c2U7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoZSk7XG4gICAgfVxuICB9IGNhdGNoIChlKSB7XG4gICAgcmVwb3J0ZXIud2FybmluZyhcbiAgICAgIGBGYWlsZWQgdG8gcnVuIHVzZWAsXG4gICAgKTtcbiAgICB0aHJvdyBuZXcgRXJyb3IoZSk7XG4gIH1cblxuICAvLyBjaGVjayBpZiB0aGVuXG4gIGlmIChzdGVwLnJ1bikge1xuICAgIC8vIHJ1biB0aGVuXG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IHNjcmlwdFJlc3VsdCA9IGF3YWl0IHJ1blNjcmlwdChzdGVwLnJ1biwge1xuICAgICAgICBjdHg6IGN0eC5wdWJsaWMsXG4gICAgICB9KTtcblxuICAgICAgc3RlcFJlc3VsdCA9IHNjcmlwdFJlc3VsdC5yZXN1bHQ7XG4gICAgICBjdHggPSBzZXRPa1Jlc3VsdChjdHgsIHN0ZXBSZXN1bHQpO1xuICAgICAgY3R4LnB1YmxpYy5zdGF0ZSA9IHNjcmlwdFJlc3VsdC5jdHguc3RhdGU7XG4gICAgICByZXBvcnRlci5kZWJ1ZyhcbiAgICAgICAgYFJ1biBzY3JpcHQgcmVzdWx0OiAke1xuICAgICAgICAgIHR5cGVvZiBzdGVwUmVzdWx0ID09PSBcInN0cmluZ1wiXG4gICAgICAgICAgICA/IHN0ZXBSZXN1bHRcbiAgICAgICAgICAgIDogSlNPTi5zdHJpbmdpZnkoc3RlcFJlc3VsdCwgbnVsbCwgMilcbiAgICAgICAgfWAsXG4gICAgICApO1xuICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgIHJlcG9ydGVyLndhcm5pbmcoXG4gICAgICAgIGBGYWlsZWQgdG8gcnVuIHNjcmlwdGAsXG4gICAgICApO1xuICAgICAgdGhyb3cgbmV3IEVycm9yKGUpO1xuICAgIH1cbiAgfVxuXG4gIGN0eC5wdWJsaWMub2sgPSB0cnVlO1xuICByZXR1cm4gY3R4O1xufVxuIl19