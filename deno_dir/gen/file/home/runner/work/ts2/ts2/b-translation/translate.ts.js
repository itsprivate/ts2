import { TARGET_LANGUAGES, TRANSLATED_FIELDS } from "../common/constant.ts";
import { parseIdentifier, getPathIdentifierByIdentifier, writeJson, get, getFinalHeadline, getDataFilePath, } from "../common/util.ts";
import set from "https://deno.land/x/lodash@4.17.15-es/set.js";
import { parse } from "https://deno.land/std@0.121.0/path/mod.ts";
import puppeteer from "https://deno.land/x/puppeteer@9.0.2/mod.ts";
import d from "./d.js";
import zhToHant from "./zh-to-hant.ts";
const homepage = "https://www.deepl.com/translator";
const isDev = Deno.env.get("ENV") === "dev";
export default async function (files) {
    const results = [];
    let browser = null;
    let page = null;
    const getBrowser = async () => {
        if (browser)
            return browser;
        browser = await puppeteer.launch({
            devtools: false,
            headless: !isDev,
            defaultViewport: { width: 1370, height: 1200 },
            args: ["--lang=zh-Hans,zh", "--disable-gpu"],
        });
        browser.on("disconnected", () => (browser = null));
        return browser;
    };
    const getNewPage = async (force) => {
        if (page)
            return page;
        browser = await getBrowser();
        const pages = await browser.pages();
        if (pages[0] && !force) {
            page = pages[0];
        }
        else {
            page = await browser.newPage();
        }
        await page.setUserAgent("Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/78.0.3904.108 Safari/537.36");
        await page.goto(homepage, { waitUntil: "domcontentloaded" });
        await page.waitForTimeout(2000);
        return page;
    };
    let currentHandledFiles = 0;
    for (let fileIndex = 0; fileIndex < files.length; fileIndex++) {
        if (!isDev) {
            if (currentHandledFiles > 100) {
                currentHandledFiles = 1;
                browser = await getBrowser();
                const pages = await browser.pages();
                if (pages.length > 1 && page) {
                    page.close();
                }
                page = null;
                page = await getNewPage(true);
            }
            else {
                currentHandledFiles++;
                page = await getNewPage(false);
            }
        }
        const file = files[fileIndex];
        const parsedFilePath = parse(file);
        const identifier = parsedFilePath.name;
        const pathIdentifier = getPathIdentifierByIdentifier(identifier);
        const data = await Deno.readTextFile(file);
        const item = JSON.parse(data);
        const finalItem = await translateItem(item, page);
        await writeJson(getDataFilePath(`changed/${pathIdentifier}.json`), finalItem);
        console.log("remove raw file: ", file);
        await Deno.remove(file);
        results.push(true);
    }
    if (page) {
        await page.close();
    }
    if (browser) {
        await browser.close();
    }
    return results;
}
export async function translateItem(item, page) {
    if (!(item && item.identifier)) {
        throw new Error("Invalid item, item must have identifier");
    }
    const identifier = item.identifier;
    const parsedIdentifier = parseIdentifier(identifier);
    const sourceLanguage = parsedIdentifier.language;
    let context = {
        "@vocab": "https://schema.org/",
        "@language": sourceLanguage,
    };
    for (const targetLanguage of TARGET_LANGUAGES) {
        for (const translatedKey of TRANSLATED_FIELDS) {
            const translatedValue = get(item, translatedKey);
            const translatedTargetKey = `${translatedKey}_${targetLanguage}`;
            const translatedTargetValue = get(item, translatedTargetKey);
            if (translatedValue && translatedTargetValue === undefined) {
                const dTargetLanguage = toDLanguage(targetLanguage);
                const translated = await d(page, translatedValue, sourceLanguage, dTargetLanguage, {
                    mock: isDev || page === null,
                });
                console.log("source", translatedKey, parsedIdentifier.language, item.headline);
                console.log("translated", translatedTargetKey, dTargetLanguage, translated.result);
                const targetHant = targetLanguage === "zh-Hans" ? "zh-Hant" : undefined;
                if (translated.result) {
                    item = set(item, translatedKey, getFinalHeadline(item, translatedValue));
                    item = set(item, translatedTargetKey, getFinalHeadline(item, translated.result));
                    context = set(context, getContextKey(translatedTargetKey), {
                        "@id": getContextKey(translatedKey),
                        "@language": targetLanguage,
                    });
                    if (targetHant) {
                        const translatedTargetHantKey = `${translatedKey}_${targetHant}`;
                        item = set(item, translatedTargetHantKey, getFinalHeadline(item, zhToHant(translated.result)));
                        context = set(context, getContextKey(translatedTargetHantKey), {
                            "@id": getContextKey(translatedKey),
                            "@language": targetHant,
                        });
                    }
                }
                else {
                    throw new Error(translated.result);
                }
            }
            else {
                console.log("translated result exists, skip", translatedKey, translatedTargetKey);
            }
        }
    }
    context["@version"] = 1.1;
    item["@context"] = ["https://schema.org", context];
    return item;
}
function toDLanguage(lang) {
    if (lang === "zh-Hans") {
        return "zh-ZH";
    }
    else {
        return lang;
    }
}
function getContextKey(key) {
    const lastDotIndex = key.lastIndexOf(".");
    const isIncludeNest = lastDotIndex > 0;
    const translatedContextTargetKey = key.substring(isIncludeNest ? lastDotIndex + 1 : 0, key.length);
    return translatedContextTargetKey;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidHJhbnNsYXRlLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsidHJhbnNsYXRlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxnQkFBZ0IsRUFBRSxpQkFBaUIsRUFBRSxNQUFNLHVCQUF1QixDQUFDO0FBQzVFLE9BQU8sRUFDTCxlQUFlLEVBQ2YsNkJBQTZCLEVBQzdCLFNBQVMsRUFDVCxHQUFHLEVBQ0gsZ0JBQWdCLEVBQ2hCLGVBQWUsR0FDaEIsTUFBTSxtQkFBbUIsQ0FBQztBQUMzQixPQUFPLEdBQUcsTUFBTSw4Q0FBOEMsQ0FBQztBQUMvRCxPQUFPLEVBQUUsS0FBSyxFQUFFLE1BQU0sMkNBQTJDLENBQUM7QUFDbEUsT0FBTyxTQUdOLE1BQU0sNENBQTRDLENBQUM7QUFDcEQsT0FBTyxDQUFDLE1BQU0sUUFBUSxDQUFDO0FBTXZCLE9BQU8sUUFBUSxNQUFNLGlCQUFpQixDQUFDO0FBQ3ZDLE1BQU0sUUFBUSxHQUFHLGtDQUFrQyxDQUFDO0FBQ3BELE1BQU0sS0FBSyxHQUFHLElBQUksQ0FBQyxHQUFHLENBQUMsR0FBRyxDQUFDLEtBQUssQ0FBQyxLQUFLLEtBQUssQ0FBQztBQUM1QyxNQUFNLENBQUMsT0FBTyxDQUFDLEtBQUssV0FBVyxLQUFlO0lBQzVDLE1BQU0sT0FBTyxHQUFjLEVBQUUsQ0FBQztJQUM5QixJQUFJLE9BQU8sR0FBbUIsSUFBSSxDQUFDO0lBQ25DLElBQUksSUFBSSxHQUFnQixJQUFJLENBQUM7SUFDN0IsTUFBTSxVQUFVLEdBQUcsS0FBSyxJQUFJLEVBQUU7UUFDNUIsSUFBSSxPQUFPO1lBQUUsT0FBTyxPQUFPLENBQUM7UUFDNUIsT0FBTyxHQUFHLE1BQU0sU0FBUyxDQUFDLE1BQU0sQ0FBQztZQUMvQixRQUFRLEVBQUUsS0FBSztZQUNmLFFBQVEsRUFBRSxDQUFDLEtBQUs7WUFDaEIsZUFBZSxFQUFFLEVBQUUsS0FBSyxFQUFFLElBQUksRUFBRSxNQUFNLEVBQUUsSUFBSSxFQUFFO1lBQzlD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bnRlbnQiOlsiaW1wb3J0IHsgVEFSR0VUX0xBTkdVQUdFUywgVFJBTlNMQVRFRF9GSUVMRFMgfSBmcm9tIFwiLi4vY29tbW9uL2NvbnN0YW50LnRzXCI7XG5pbXBvcnQge1xuICBwYXJzZUlkZW50aWZpZXIsXG4gIGdldFBhdGhJZGVudGlmaWVyQnlJZGVudGlmaWVyLFxuICB3cml0ZUpzb24sXG4gIGdldCxcbiAgZ2V0RmluYWxIZWFkbGluZSxcbiAgZ2V0RGF0YUZpbGVQYXRoLFxufSBmcm9tIFwiLi4vY29tbW9uL3V0aWwudHNcIjtcbmltcG9ydCBzZXQgZnJvbSBcImh0dHBzOi8vZGVuby5sYW5kL3gvbG9kYXNoQDQuMTcuMTUtZXMvc2V0LmpzXCI7XG5pbXBvcnQgeyBwYXJzZSB9IGZyb20gXCJodHRwczovL2Rlbm8ubGFuZC9zdGRAMC4xMjEuMC9wYXRoL21vZC50c1wiO1xuaW1wb3J0IHB1cHBldGVlciwge1xuICBCcm93c2VyLFxuICBQYWdlLFxufSBmcm9tIFwiaHR0cHM6Ly9kZW5vLmxhbmQveC9wdXBwZXRlZXJAOS4wLjIvbW9kLnRzXCI7XG5pbXBvcnQgZCBmcm9tIFwiLi9kLmpzXCI7XG4vLyBpbXBvcnQgeyBKc29uTGREb2N1bWVudCB9IGZyb20gXCJodHRwczovL2Rlbm9wa2cuY29tL0RlZmluaXRlbHlUeXBlZC9EZWZpbml0ZWx5VHlwZWRAbWFzdGVyL3R5cGVzL2pzb25sZC9pbmRleC5kLnRzXCI7XG5pbXBvcnQge1xuICBOb2RlT2JqZWN0LFxuICBDb250ZXh0RGVmaW5pdGlvbixcbn0gZnJvbSBcImh0dHBzOi8vY2RuLnNreXBhY2suZGV2L2pzb25sZD9kdHNcIjtcbmltcG9ydCB6aFRvSGFudCBmcm9tIFwiLi96aC10by1oYW50LnRzXCI7XG5jb25zdCBob21lcGFnZSA9IFwiaHR0cHM6Ly93d3cuZGVlcGwuY29tL3RyYW5zbGF0b3JcIjtcbmNvbnN0IGlzRGV2ID0gRGVuby5lbnYuZ2V0KFwiRU5WXCIpID09PSBcImRldlwiO1xuZXhwb3J0IGRlZmF1bHQgYXN5bmMgZnVuY3Rpb24gKGZpbGVzOiBzdHJpbmdbXSkge1xuICBjb25zdCByZXN1bHRzOiBib29sZWFuW10gPSBbXTtcbiAgbGV0IGJyb3dzZXI6IEJyb3dzZXIgfCBudWxsID0gbnVsbDtcbiAgbGV0IHBhZ2U6IFBhZ2UgfCBudWxsID0gbnVsbDtcbiAgY29uc3QgZ2V0QnJvd3NlciA9IGFzeW5jICgpID0+IHtcbiAgICBpZiAoYnJvd3NlcikgcmV0dXJuIGJyb3dzZXI7XG4gICAgYnJvd3NlciA9IGF3YWl0IHB1cHBldGVlci5sYXVuY2goe1xuICAgICAgZGV2dG9vbHM6IGZhbHNlLFxuICAgICAgaGVhZGxlc3M6ICFpc0RldixcbiAgICAgIGRlZmF1bHRWaWV3cG9ydDogeyB3aWR0aDogMTM3MCwgaGVpZ2h0OiAxMjAwIH0sXG4gICAgICBhcmdzOiBbXCItLWxhbmc9emgtSGFucyx6aFwiLCBcIi0tZGlzYWJsZS1ncHVcIl0sXG4gICAgfSk7XG4gICAgYnJvd3Nlci5vbihcImRpc2Nvbm5lY3RlZFwiLCAoKSA9PiAoYnJvd3NlciA9IG51bGwpKTtcbiAgICByZXR1cm4gYnJvd3NlcjtcbiAgfTtcblxuICBjb25zdCBnZXROZXdQYWdlID0gYXN5bmMgKGZvcmNlOiBib29sZWFuKTogUHJvbWlzZTxQYWdlPiA9PiB7XG4gICAgaWYgKHBhZ2UpIHJldHVybiBwYWdlO1xuICAgIGJyb3dzZXIgPSBhd2FpdCBnZXRCcm93c2VyKCk7XG4gICAgY29uc3QgcGFnZXMgPSBhd2FpdCBicm93c2VyLnBhZ2VzKCk7XG4gICAgaWYgKHBhZ2VzWzBdICYmICFmb3JjZSkge1xuICAgICAgcGFnZSA9IHBhZ2VzWzBdO1xuICAgIH0gZWxzZSB7XG4gICAgICBwYWdlID0gYXdhaXQgYnJvd3Nlci5uZXdQYWdlKCk7XG4gICAgfVxuICAgIGF3YWl0IHBhZ2Uuc2V0VXNlckFnZW50KFxuICAgICAgXCJNb3ppbGxhLzUuMCAoWDExOyBMaW51eCB4ODZfNjQpIEFwcGxlV2ViS2l0LzUzNy4zNiAoS0hUTUwsIGxpa2UgR2Vja28pIENocm9tZS83OC4wLjM5MDQuMTA4IFNhZmFyaS81MzcuMzZcIlxuICAgICk7XG4gICAgLy8gYXdhaXQgcGFnZS5zZXRWaWV3cG9ydCh7IHdpZHRoOiAxMzcwLCBoZWlnaHQ6IDEyMDAgfSk7XG4gICAgYXdhaXQgcGFnZS5nb3RvKGhvbWVwYWdlLCB7IHdhaXRVbnRpbDogXCJkb21jb250ZW50bG9hZGVkXCIgfSk7XG5cbiAgICBhd2FpdCBwYWdlLndhaXRGb3JUaW1lb3V0KDIwMDApO1xuICAgIC8vIGF3YWl0IHBhZ2Uuc2NyZWVuc2hvdCh7IHBhdGg6IFwiZXhhbXBsZS5wbmdcIiB9KTtcblxuICAgIHJldHVybiBwYWdlO1xuICB9O1xuICAvLyBoYW5kbGVkIGZpbGVzIG51bWJlclxuICBsZXQgY3VycmVudEhhbmRsZWRGaWxlcyA9IDA7XG4gIGZvciAobGV0IGZpbGVJbmRleCA9IDA7IGZpbGVJbmRleCA8IGZpbGVzLmxlbmd0aDsgZmlsZUluZGV4KyspIHtcbiAgICBpZiAoIWlzRGV2KSB7XG4gICAgICBpZiAoY3VycmVudEhhbmRsZWRGaWxlcyA+IDEwMCkge1xuICAgICAgICBjdXJyZW50SGFuZGxlZEZpbGVzID0gMTtcbiAgICAgICAgLy8gcmVmcmVzaCBwYWdlXG4gICAgICAgIGJyb3dzZXIgPSBhd2FpdCBnZXRCcm93c2VyKCk7XG4gICAgICAgIGNvbnN0IHBhZ2VzID0gYXdhaXQgYnJvd3NlciEucGFnZXMoKTtcblxuICAgICAgICBpZiAocGFnZXMubGVuZ3RoID4gMSAmJiBwYWdlKSB7XG4gICAgICAgICAgcGFnZSEuY2xvc2UoKTtcbiAgICAgICAgfVxuICAgICAgICBwYWdlID0gbnVsbDtcbiAgICAgICAgcGFnZSA9IGF3YWl0IGdldE5ld1BhZ2UodHJ1ZSk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBjdXJyZW50SGFuZGxlZEZpbGVzKys7XG4gICAgICAgIC8vIG9wZW4gcHVwcGV0ZWVyXG4gICAgICAgIHBhZ2UgPSBhd2FpdCBnZXROZXdQYWdlKGZhbHNlKTtcbiAgICAgIH1cbiAgICB9XG4gICAgY29uc3QgZmlsZSA9IGZpbGVzW2ZpbGVJbmRleF07XG4gICAgY29uc3QgcGFyc2VkRmlsZVBhdGggPSBwYXJzZShmaWxlKTtcbiAgICBjb25zdCBpZGVudGlmaWVyID0gcGFyc2VkRmlsZVBhdGgubmFtZTtcbiAgICBjb25zdCBwYXRoSWRlbnRpZmllciA9IGdldFBhdGhJZGVudGlmaWVyQnlJZGVudGlmaWVyKGlkZW50aWZpZXIpO1xuXG4gICAgY29uc3QgZGF0YSA9IGF3YWl0IERlbm8ucmVhZFRleHRGaWxlKGZpbGUpO1xuICAgIGNvbnN0IGl0ZW0gPSBKU09OLnBhcnNlKGRhdGEpIGFzIE5vZGVPYmplY3Q7XG4gICAgY29uc3QgZmluYWxJdGVtID0gYXdhaXQgdHJhbnNsYXRlSXRlbShpdGVtLCBwYWdlKTtcbiAgICAvLyB3cml0ZSB0byBjaGFuZ2VkIHBhdGhcbiAgICBhd2FpdCB3cml0ZUpzb24oXG4gICAgICBnZXREYXRhRmlsZVBhdGgoYGNoYW5nZWQvJHtwYXRoSWRlbnRpZmllcn0uanNvbmApLFxuICAgICAgZmluYWxJdGVtXG4gICAgKTtcbiAgICAvLyBkZWxldGUgcmF3IGZpbGVzXG4gICAgY29uc29sZS5sb2coXCJyZW1vdmUgcmF3IGZpbGU6IFwiLCBmaWxlKTtcblxuICAgIGF3YWl0IERlbm8ucmVtb3ZlKGZpbGUpO1xuICAgIHJlc3VsdHMucHVzaCh0cnVlKTtcbiAgfVxuICBpZiAocGFnZSkge1xuICAgIGF3YWl0IHBhZ2UuY2xvc2UoKTtcbiAgfVxuICAvLyBxdWl0IHB1cHBldGVlclxuICBpZiAoYnJvd3Nlcikge1xuICAgIGF3YWl0IChicm93c2VyIGFzIEJyb3dzZXIpIS5jbG9zZSgpO1xuICB9XG5cbiAgcmV0dXJuIHJlc3VsdHM7XG59XG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gdHJhbnNsYXRlSXRlbShpdGVtOiBOb2RlT2JqZWN0LCBwYWdlOiBQYWdlIHwgbnVsbCkge1xuICBpZiAoIShpdGVtICYmIGl0ZW0uaWRlbnRpZmllcikpIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoXCJJbnZhbGlkIGl0ZW0sIGl0ZW0gbXVzdCBoYXZlIGlkZW50aWZpZXJcIik7XG4gIH1cbiAgY29uc3QgaWRlbnRpZmllciA9IGl0ZW0uaWRlbnRpZmllciBhcyBzdHJpbmc7XG4gIGNvbnN0IHBhcnNlZElkZW50aWZpZXIgPSBwYXJzZUlkZW50aWZpZXIoaWRlbnRpZmllcik7XG4gIGNvbnN0IHNvdXJjZUxhbmd1YWdlID0gcGFyc2VkSWRlbnRpZmllci5sYW5ndWFnZTtcblxuICBsZXQgY29udGV4dDogQ29udGV4dERlZmluaXRpb24gPSB7XG4gICAgXCJAdm9jYWJcIjogXCJodHRwczovL3NjaGVtYS5vcmcvXCIsXG4gICAgXCJAbGFuZ3VhZ2VcIjogc291cmNlTGFuZ3VhZ2UsXG4gIH07XG4gIGZvciAoY29uc3QgdGFyZ2V0TGFuZ3VhZ2Ugb2YgVEFSR0VUX0xBTkdVQUdFUykge1xuICAgIC8vIFRPRE9cbiAgICBmb3IgKGNvbnN0IHRyYW5zbGF0ZWRLZXkgb2YgVFJBTlNMQVRFRF9GSUVMRFMpIHtcbiAgICAgIGNvbnN0IHRyYW5zbGF0ZWRWYWx1ZSA9IGdldChpdGVtLCB0cmFuc2xhdGVkS2V5KSBhcyBzdHJpbmc7XG4gICAgICBjb25zdCB0cmFuc2xhdGVkVGFyZ2V0S2V5ID0gYCR7dHJhbnNsYXRlZEtleX1fJHt0YXJnZXRMYW5ndWFnZX1gO1xuXG4gICAgICBjb25zdCB0cmFuc2xhdGVkVGFyZ2V0VmFsdWUgPSBnZXQoaXRlbSwgdHJhbnNsYXRlZFRhcmdldEtleSk7XG4gICAgICBpZiAodHJhbnNsYXRlZFZhbHVlICYmIHRyYW5zbGF0ZWRUYXJnZXRWYWx1ZSA9PT0gdW5kZWZpbmVkKSB7XG4gICAgICAgIGNvbnN0IGRUYXJnZXRMYW5ndWFnZSA9IHRvRExhbmd1YWdlKHRhcmdldExhbmd1YWdlKTtcbiAgICAgICAgY29uc3QgdHJhbnNsYXRlZCA9IGF3YWl0IGQoXG4gICAgICAgICAgcGFnZSxcbiAgICAgICAgICB0cmFuc2xhdGVkVmFsdWUsXG4gICAgICAgICAgc291cmNlTGFuZ3VhZ2UsXG4gICAgICAgICAgZFRhcmdldExhbmd1YWdlLFxuICAgICAgICAgIHtcbiAgICAgICAgICAgIG1vY2s6IGlzRGV2IHx8IHBhZ2UgPT09IG51bGwsXG4gICAgICAgICAgfVxuICAgICAgICApO1xuICAgICAgICBjb25zb2xlLmxvZyhcbiAgICAgICAgICBcInNvdXJjZVwiLFxuICAgICAgICAgIHRyYW5zbGF0ZWRLZXksXG4gICAgICAgICAgcGFyc2VkSWRlbnRpZmllci5sYW5ndWFnZSxcbiAgICAgICAgICBpdGVtLmhlYWRsaW5lXG4gICAgICAgICk7XG4gICAgICAgIGNvbnNvbGUubG9nKFxuICAgICAgICAgIFwidHJhbnNsYXRlZFwiLFxuICAgICAgICAgIHRyYW5zbGF0ZWRUYXJnZXRLZXksXG4gICAgICAgICAgZFRhcmdldExhbmd1YWdlLFxuICAgICAgICAgIHRyYW5zbGF0ZWQucmVzdWx0XG4gICAgICAgICk7XG4gICAgICAgIGNvbnN0IHRhcmdldEhhbnQgPSB0YXJnZXRMYW5ndWFnZSA9PT0gXCJ6aC1IYW5zXCIgPyBcInpoLUhhbnRcIiA6IHVuZGVmaW5lZDtcbiAgICAgICAgaWYgKHRyYW5zbGF0ZWQucmVzdWx0KSB7XG4gICAgICAgICAgaXRlbSA9IHNldChcbiAgICAgICAgICAgIGl0ZW0sXG4gICAgICAgICAgICB0cmFuc2xhdGVkS2V5LFxuICAgICAgICAgICAgZ2V0RmluYWxIZWFkbGluZShpdGVtLCB0cmFuc2xhdGVkVmFsdWUpXG4gICAgICAgICAgKSBhcyBOb2RlT2JqZWN0O1xuXG4gICAgICAgICAgaXRlbSA9IHNldChcbiAgICAgICAgICAgIGl0ZW0sXG4gICAgICAgICAgICB0cmFuc2xhdGVkVGFyZ2V0S2V5LFxuICAgICAgICAgICAgZ2V0RmluYWxIZWFkbGluZShpdGVtLCB0cmFuc2xhdGVkLnJlc3VsdClcbiAgICAgICAgICApIGFzIE5vZGVPYmplY3Q7XG4gICAgICAgICAgY29udGV4dCA9IHNldChjb250ZXh0LCBnZXRDb250ZXh0S2V5KHRyYW5zbGF0ZWRUYXJnZXRLZXkpLCB7XG4gICAgICAgICAgICBcIkBpZFwiOiBnZXRDb250ZXh0S2V5KHRyYW5zbGF0ZWRLZXkpLFxuICAgICAgICAgICAgXCJAbGFuZ3VhZ2VcIjogdGFyZ2V0TGFuZ3VhZ2UsXG4gICAgICAgICAgfSkgYXMgQ29udGV4dERlZmluaXRpb247XG4gICAgICAgICAgLy8gY2hhbmdlIGNvbnRleHRcbiAgICAgICAgICBpZiAodGFyZ2V0SGFudCkge1xuICAgICAgICAgICAgY29uc3QgdHJhbnNsYXRlZFRhcmdldEhhbnRLZXkgPSBgJHt0cmFuc2xhdGVkS2V5fV8ke3RhcmdldEhhbnR9YDtcblxuICAgICAgICAgICAgaXRlbSA9IHNldChcbiAgICAgICAgICAgICAgaXRlbSxcbiAgICAgICAgICAgICAgdHJhbnNsYXRlZFRhcmdldEhhbnRLZXksXG4gICAgICAgICAgICAgIGdldEZpbmFsSGVhZGxpbmUoaXRlbSwgemhUb0hhbnQodHJhbnNsYXRlZC5yZXN1bHQpKVxuICAgICAgICAgICAgKSBhcyBOb2RlT2JqZWN0O1xuICAgICAgICAgICAgY29udGV4dCA9IHNldChjb250ZXh0LCBnZXRDb250ZXh0S2V5KHRyYW5zbGF0ZWRUYXJnZXRIYW50S2V5KSwge1xuICAgICAgICAgICAgICBcIkBpZFwiOiBnZXRDb250ZXh0S2V5KHRyYW5zbGF0ZWRLZXkpLFxuICAgICAgICAgICAgICBcIkBsYW5ndWFnZVwiOiB0YXJnZXRIYW50LFxuICAgICAgICAgICAgfSkgYXMgQ29udGV4dERlZmluaXRpb247XG4gICAgICAgICAgfVxuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIHRocm93IG5ldyBFcnJvcih0cmFuc2xhdGVkLnJlc3VsdCk7XG4gICAgICAgIH1cbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGNvbnNvbGUubG9nKFxuICAgICAgICAgIFwidHJhbnNsYXRlZCByZXN1bHQgZXhpc3RzLCBza2lwXCIsXG4gICAgICAgICAgdHJhbnNsYXRlZEtleSxcbiAgICAgICAgICB0cmFuc2xhdGVkVGFyZ2V0S2V5XG4gICAgICAgICk7XG4gICAgICB9XG4gICAgfVxuICB9XG4gIChjb250ZXh0IGFzIFJlY29yZDxzdHJpbmcsIG51bWJlcj4pW1wiQHZlcnNpb25cIl0gPSAxLjE7XG4gIGl0ZW1bXCJAY29udGV4dFwiXSA9IFtcImh0dHBzOi8vc2NoZW1hLm9yZ1wiLCBjb250ZXh0XTtcbiAgLy8gY29uc29sZS5sb2coXCJmaW5hbCBpdGVtXCIsIEpTT04uc3RyaW5naWZ5KGl0ZW0sIG51bGwsIDIpKTtcbiAgcmV0dXJuIGl0ZW07XG59XG5cbmZ1bmN0aW9uIHRvRExhbmd1YWdlKGxhbmc6IHN0cmluZykge1xuICBpZiAobGFuZyA9PT0gXCJ6aC1IYW5zXCIpIHtcbiAgICByZXR1cm4gXCJ6aC1aSFwiO1xuICB9IGVsc2Uge1xuICAgIHJldHVybiBsYW5nO1xuICB9XG59XG5cbmZ1bmN0aW9uIGdldENvbnRleHRLZXkoa2V5OiBzdHJpbmcpIHtcbiAgY29uc3QgbGFzdERvdEluZGV4ID0ga2V5Lmxhc3RJbmRleE9mKFwiLlwiKTtcbiAgY29uc3QgaXNJbmNsdWRlTmVzdCA9IGxhc3REb3RJbmRleCA+IDA7XG4gIC8vIHNoYXJlZENvbnRlbnQuaGVhZGxpbmVcbiAgY29uc3QgdHJhbnNsYXRlZENvbnRleHRUYXJnZXRLZXkgPSBrZXkuc3Vic3RyaW5nKFxuICAgIGlzSW5jbHVkZU5lc3QgPyBsYXN0RG90SW5kZXggKyAxIDogMCxcbiAgICBrZXkubGVuZ3RoXG4gICk7XG4gIHJldHVybiB0cmFuc2xhdGVkQ29udGV4dFRhcmdldEtleTtcbn1cbiJdfQ==